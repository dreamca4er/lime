select
    c.clientid
    , c.fio
    , c.PhoneNumber
    , p.Productid
    , p.ContractNumber
    , th.MaxAmount
    , p.StatusName
from prd.vw_product p
inner join client.vw_client c on c.clientid = p.ClientId
inner join pmt.Payment pay on pay.ContractNumber = p.ContractNumber
outer apply
(
    select max(th.MaxAmount) as MaxAmount
    from client.vw_TariffHistory th
    where th.ClientId = p.ClientId
        and th.IsLatest = 1
) th
where 1=1 
    and p.PaymentWay = 2
--    and p.Status = 2
    and p.Productid in (414805,414806,414808,414810,414811,414812,414822,414827,414829,414830,414834,414839,414841,414844,414847,414849,414850,414851,414853,414856,414859,414861,414863,414865,414866,414867,414869,414871,414872,414874,414875,414877,414879,414880,414881,414883,414884,414885,414887,414888,414890,414892,414893,414895,414897,414898,414899,414901,414902,414904,414905,414907,414909,414910,414912,414913,414915,414917,414918,414919,414921,414923,414924,414925,414927,414929,414931,414933,414934,414936,414938,414939
,414940,414941,414942,414944,414946,414947,414949,414950,414951,414952,414953,414955,414956,414957,414958,414960,414962,414964,414965,414967,414969,414970,414972,414973,414975,414976,414978,414980,414981,414983,414984,414985,414987,414989,414991,414993,414995,414997,414998,414999,415001,415003,415004,415006,415008,415009, 415011)